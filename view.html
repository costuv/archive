<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>View - ArchIve</title>
  <link rel="preconnect" href="https://ogwtptuzvcugxctveutc.supabase.co" />
  <link rel="dns-prefetch" href="https://ogwtptuzvcugxctveutc.supabase.co" />
  <link rel="stylesheet" href="css/styles.css">
  <script>
    if (localStorage.getItem('theme') === 'dark') {
      document.documentElement.classList.add('dark-mode');
    }
  </script>
  <style>
    .view-page {
      min-height: 100vh;
      background-color: var(--color-gray-50);
    }
    
    .dark-mode .view-page {
      background-color: #000000;
    }
    
    .view-header {
      position: sticky;
      top: 0;
      z-index: 100;
      background-color: var(--color-white);
      border-bottom: 3px solid var(--color-black);
      padding: 1rem 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
    }
    
    .dark-mode .view-header {
      background-color: #000000;
      border-color: #262626;
    }
    
    .view-header-left {
      display: flex;
      align-items: center;
      gap: 1rem;
      flex: 1;
      min-width: 0;
    }
    
    .back-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 2.5rem;
      height: 2.5rem;
      border: 2px solid var(--color-black);
      background-color: var(--color-white);
      cursor: pointer;
      transition: all 0.15s ease;
      flex-shrink: 0;
    }
    
    .back-btn:hover {
      background-color: var(--color-gray-100);
    }
    
    .dark-mode .back-btn {
      background-color: #0a0a0a;
      border-color: #262626;
      color: #ffffff;
    }
    
    .dark-mode .back-btn:hover {
      background-color: #171717;
    }
    
    .back-btn .icon {
      width: 1.25rem;
      height: 1.25rem;
    }
    
    .view-title {
      font-family: var(--font-serif);
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--color-black);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .dark-mode .view-title {
      color: #ffffff;
    }
    
    .view-header-actions {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-shrink: 0;
    }
    
    .action-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      border: 2px solid var(--color-black);
      background-color: var(--color-black);
      color: var(--color-white);
      font-family: var(--font-mono);
      font-size: 0.8125rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s ease;
    }
    
    .action-btn:hover {
      background-color: var(--color-gray-800);
    }
    
    .dark-mode .action-btn {
      background-color: #ffffff;
      color: #000000;
      border-color: #ffffff;
    }
    
    .dark-mode .action-btn:hover {
      background-color: #e5e5e5;
    }
    
    .action-btn .icon {
      width: 1rem;
      height: 1rem;
    }
    
    .view-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem 1.5rem;
    }
    
    .view-content {
      background-color: var(--color-white);
      border: 4px solid var(--color-black);
      box-shadow: 8px 8px 0px 0px rgba(0, 0, 0, 1);
      overflow: hidden;
    }
    
    .dark-mode .view-content {
      background-color: #0a0a0a;
      border-color: #262626;
      box-shadow: 8px 8px 0px 0px rgba(255, 255, 255, 0.1);
    }
    
    /* File viewer area */
    .file-viewer {
      width: 100%;
      min-height: 400px;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: var(--color-gray-100);
      position: relative;
    }
    
    .dark-mode .file-viewer {
      background-color: #171717;
    }
    
    .file-viewer iframe,
    .file-viewer embed {
      width: 100%;
      height: 80vh;
      border: none;
    }
    
    .file-viewer img {
      max-width: 100%;
      max-height: 80vh;
      object-fit: contain;
    }
    
    .file-viewer video,
    .file-viewer audio {
      max-width: 100%;
      width: 100%;
    }
    
    .file-viewer audio {
      padding: 2rem;
      min-height: 60px;
      display: block;
    }
    
    .file-viewer-placeholder {
      text-align: center;
      padding: 4rem 2rem;
    }
    
    .file-viewer-placeholder .icon {
      width: 4rem;
      height: 4rem;
      color: var(--color-gray-400);
      margin-bottom: 1rem;
    }
    
    .dark-mode .file-viewer-placeholder .icon {
      color: #525252;
    }
    
    .file-viewer-placeholder p {
      font-family: var(--font-mono);
      font-size: 0.875rem;
      color: var(--color-gray-500);
    }
    
    .dark-mode .file-viewer-placeholder p {
      color: #737373;
    }
    
    /* File info section */
    .file-info {
      padding: 1.5rem;
      border-top: 3px solid var(--color-black);
    }
    
    .dark-mode .file-info {
      border-color: #262626;
    }
    
    .file-info-title {
      font-family: var(--font-serif);
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--color-black);
      margin-bottom: 0.5rem;
    }
    
    .dark-mode .file-info-title {
      color: #ffffff;
    }
    
    .file-info-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 1rem;
      font-family: var(--font-mono);
      font-size: 0.75rem;
      color: var(--color-gray-500);
    }
    
    .dark-mode .file-info-meta {
      color: #737373;
    }
    
    .file-info-meta span {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }
    
    .file-info-meta .icon {
      width: 0.875rem;
      height: 0.875rem;
    }
    
    .file-info-description {
      font-family: var(--font-sans);
      font-size: 0.9375rem;
      color: var(--color-gray-700);
      line-height: 1.6;
      margin-bottom: 1rem;
    }
    
    .dark-mode .file-info-description {
      color: #a3a3a3;
    }
    
    .file-info-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    
    .file-tag {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.25rem 0.625rem;
      background-color: var(--color-gray-100);
      border: 1px solid var(--color-gray-300);
      font-family: var(--font-mono);
      font-size: 0.6875rem;
      color: var(--color-gray-600);
    }
    
    .dark-mode .file-tag {
      background-color: #171717;
      border-color: #404040;
      color: #a3a3a3;
    }
    
    .file-tag .icon {
      width: 0.75rem;
      height: 0.75rem;
    }
    
    /* Loading state */
    .loading-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 50vh;
      text-align: center;
    }
    
    .loading-bar-container {
      width: 200px;
      height: 6px;
      background-color: var(--color-gray-200, #e5e7eb);
      border: 2px solid var(--color-black, #000000);
      overflow: hidden;
      margin-bottom: 1rem;
    }
    
    .dark-mode .loading-bar-container {
      background-color: #262626;
      border-color: #404040;
    }
    
    .loading-bar {
      height: 100%;
      width: 40%;
      background-color: #dc2626;
      animation: loading-slide 1s ease-in-out infinite;
    }
    
    @keyframes loading-slide {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(350%); }
    }
    
    .loading-state p {
      font-family: var(--font-mono);
      font-size: 0.875rem;
      color: var(--color-gray-500);
    }
    
    .dark-mode .loading-state p {
      color: #737373;
    }
    
    /* Error state */
    .error-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 50vh;
      text-align: center;
      padding: 2rem;
    }
    
    .error-state .icon {
      width: 4rem;
      height: 4rem;
      color: #dc2626;
      margin-bottom: 1rem;
    }
    
    .error-state h2 {
      font-family: var(--font-serif);
      font-size: 1.5rem;
      color: var(--color-black);
      margin-bottom: 0.5rem;
    }
    
    .dark-mode .error-state h2 {
      color: #ffffff;
    }
    
    .error-state p {
      font-family: var(--font-mono);
      font-size: 0.875rem;
      color: var(--color-gray-500);
    }
    
    .dark-mode .error-state p {
      color: #737373;
    }
    
    /* Desktop action button - ensure proper display */
    .action-btn {
      white-space: nowrap;
    }
    
    .action-btn .icon {
      flex-shrink: 0;
    }
    
    /* Mobile responsive */
    @media (max-width: 768px) {
      .view-header {
        padding: 0.75rem 1rem;
      }
      
      .view-title {
        font-size: 1rem;
      }
      
      .action-btn span:not(.icon) {
        display: none;
      }
      
      .action-btn {
        padding: 0.5rem;
      }
      
      .view-container {
        padding: 1rem;
      }
      
      .view-content {
        box-shadow: 4px 4px 0px 0px rgba(0, 0, 0, 1);
      }
      
      .dark-mode .view-content {
        box-shadow: 4px 4px 0px 0px rgba(255, 255, 255, 0.1);
      }
      
      .file-info {
        padding: 1rem;
      }
      
      .file-info-title {
        font-size: 1.25rem;
      }
      
      /* Audio player mobile fix */
      .file-viewer {
        min-height: auto;
        padding: 1rem;
      }
      
      .file-viewer audio {
        width: 100%;
        padding: 1rem 0;
      }
    }
  </style>
</head>
<body>
  <script>
    if (localStorage.getItem('theme') === 'dark') {
      document.body.classList.add('dark-mode');
    }
  </script>

  <div class="view-page">
    <header class="view-header">
      <div class="view-header-left">
        <button class="back-btn" id="back-btn" aria-label="Go back">
          <span class="icon" id="back-icon"></span>
        </button>
        <h1 class="view-title" id="view-title">Loading...</h1>
      </div>
      <div class="view-header-actions">
        <button class="action-btn" id="download-btn" style="display: none;">
          <span class="icon" id="download-icon"></span>
          <span>Download</span>
        </button>
      </div>
    </header>
    
    <main class="view-container">
      <div class="view-content" id="view-content">
        <div class="loading-state" id="loading-state">
          <div class="loading-bar-container">
            <div class="loading-bar"></div>
          </div>
          <p>Loading file...</p>
        </div>
      </div>
    </main>
  </div>

  <script src="js/icons.js"></script>
  <script src="js/supabase.js"></script>
  <script src="js/toast.js"></script>
  <script>
    // Set icons
    document.getElementById('back-icon').innerHTML = icons['arrow-left'];
    document.getElementById('download-icon').innerHTML = icons.download;
    
    // Get file ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const fileId = urlParams.get('id');
    
    // Go back button
    document.getElementById('back-btn').addEventListener('click', () => {
      if (document.referrer && document.referrer.includes(window.location.hostname)) {
        history.back();
      } else {
        window.location.href = 'index.html';
      }
    });
    
    // Get file type icon
    function getFileTypeIcon(type) {
      switch (type) {
        case 'document': return icons['file-text'];
        case 'pdf': return icons['file-type'];
        case 'image': return icons.image;
        case 'audio': return icons.music;
        case 'notice': return icons['alert-circle'];
        default: return icons.file;
      }
    }
    
    // Format date
    function formatDate(date) {
      if (!date) return '';
      const d = new Date(date);
      return d.toLocaleDateString('en-US', {
        month: 'long',
        day: 'numeric',
        year: 'numeric'
      });
    }
    
    // Detect file type from URL/extension
    function detectMediaType(url, type) {
      if (!url) return 'unknown';
      
      const ext = url.split('.').pop().toLowerCase().split('?')[0];
      
      // PDF
      if (ext === 'pdf' || type === 'pdf') return 'pdf';
      
      // Images
      if (['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg', 'bmp'].includes(ext) || type === 'image') return 'image';
      
      // Video
      if (['mp4', 'webm', 'ogg', 'mov', 'avi'].includes(ext)) return 'video';
      
      // Audio
      if (['mp3', 'wav', 'ogg', 'aac', 'm4a', 'flac'].includes(ext)) return 'audio';
      
      // Documents
      if (['doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx', 'txt'].includes(ext)) return 'document';
      
      return 'unknown';
    }
    
    // Render file viewer based on type
    function renderFileViewer(file) {
      const mediaType = detectMediaType(file.fileUrl, file.type);
      
      if (!file.fileUrl) {
        return `
          <div class="file-viewer-placeholder">
            <span class="icon">${getFileTypeIcon(file.type)}</span>
            <p>No file attached to this entry</p>
          </div>
        `;
      }
      
      switch (mediaType) {
        case 'pdf':
          // Use Google Docs viewer for PDF files for better compatibility
          const pdfViewerUrl = `https://docs.google.com/viewer?url=${encodeURIComponent(file.fileUrl)}&embedded=true`;
          return `<iframe src="${pdfViewerUrl}" title="${file.title}" allow="autoplay"></iframe>`;
        
        case 'image':
          return `<img src="${file.fileUrl}" alt="${file.title}" />`;
        
        case 'video':
          return `
            <video controls>
              <source src="${file.fileUrl}" type="video/${file.fileUrl.split('.').pop().split('?')[0]}">
              Your browser does not support the video tag.
            </video>
          `;
        
        case 'audio':
          return `
            <audio controls style="width: 100%; max-width: 600px;">
              <source src="${file.fileUrl}">
              Your browser does not support the audio tag.
            </audio>
          `;
        
        case 'document':
          return `
            <div class="file-viewer-placeholder">
              <span class="icon">${icons['file-text']}</span>
              <p>Document preview not available. Click download to view.</p>
            </div>
          `;
        
        default:
          return `
            <div class="file-viewer-placeholder">
              <span class="icon">${getFileTypeIcon(file.type)}</span>
              <p>Preview not available for this file type. Click download to view.</p>
            </div>
          `;
      }
    }
    
    // Render file info
    function renderFileInfo(file) {
      const tagsHtml = (file.tags || []).map(tag => `
        <span class="file-tag">
          ${icons.tag}
          ${tag}
        </span>
      `).join('');
      
      return `
        <div class="file-info">
          <h2 class="file-info-title">${file.title}</h2>
          <div class="file-info-meta">
            <span>${getFileTypeIcon(file.type)} ${file.type}</span>
            ${file.fileSize ? `<span>${icons.file} ${file.fileSize}</span>` : ''}
            <span>${icons.calendar} ${formatDate(file.createdAt)}</span>
            ${file.folderName ? `<span>${icons.folder} ${file.folderName}</span>` : ''}
          </div>
          ${file.description ? `<p class="file-info-description">${file.description}</p>` : ''}
          ${tagsHtml ? `<div class="file-info-tags">${tagsHtml}</div>` : ''}
        </div>
      `;
    }
    
    // Load file data
    async function loadFile() {
      if (!fileId) {
        showError('No file ID provided');
        return;
      }
      
      // Wait for Supabase
      let attempts = 0;
      while (!getSupabase() && attempts < 30) {
        await new Promise(resolve => setTimeout(resolve, 100));
        attempts++;
      }
      
      const supabase = getSupabase();
      
      if (!supabase) {
        showError('Service unavailable');
        return;
      }
      
      try {
        // Get file with folder info
        const { data: file, error } = await supabase
          .from('files')
          .select(`
            *,
            folders (name)
          `)
          .eq('id', fileId)
          .single();
        
        if (error) throw error;
        
        if (!file) {
          showError('File not found');
          return;
        }
        
        // Transform data
        const fileData = {
          id: file.id,
          title: file.title,
          description: file.description,
          type: file.type,
          folderId: file.folder_id,
          folderName: file.folders?.name,
          tags: file.tags || [],
          fileUrl: file.file_url,
          thumbnailUrl: file.thumbnail_url,
          fileName: file.file_name,
          fileSize: file.file_size,
          createdAt: file.created_at
        };
        
        // Update page
        document.getElementById('view-title').textContent = fileData.title;
        document.title = `${fileData.title} - ArchIve`;
        
        // Render content
        const contentHtml = `
          <div class="file-viewer">
            ${renderFileViewer(fileData)}
          </div>
          ${renderFileInfo(fileData)}
        `;
        
        document.getElementById('view-content').innerHTML = contentHtml;
        
        // Show download button if file exists
        if (fileData.fileUrl) {
          const downloadBtn = document.getElementById('download-btn');
          downloadBtn.style.display = 'flex';
          downloadBtn.addEventListener('click', async () => {
            try {
              showToast('Starting download...', 'success');
              const response = await fetch(fileData.fileUrl);
              const blob = await response.blob();
              const url = window.URL.createObjectURL(blob);
              const link = document.createElement('a');
              link.href = url;
              link.download = fileData.fileName || fileData.title || 'download';
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
              window.URL.revokeObjectURL(url);
            } catch (err) {
              console.error('Download error:', err);
              // Fallback: open in new tab
              window.open(fileData.fileUrl, '_blank');
            }
          });
        }
        
      } catch (err) {
        console.error('Error loading file:', err);
        showError('Failed to load file');
      }
    }
    
    // Show error state
    function showError(message) {
      document.getElementById('view-title').textContent = 'Error';
      document.getElementById('view-content').innerHTML = `
        <div class="error-state">
          <span class="icon">${icons['alert-circle']}</span>
          <h2>Oops!</h2>
          <p>${message}</p>
        </div>
      `;
    }
    
    // Initialize
    loadFile();
  </script>
</body>
</html>
